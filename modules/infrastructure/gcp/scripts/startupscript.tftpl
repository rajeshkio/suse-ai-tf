#!/bin/bash

# 1. Check if the script has already finished in a previous boot
DONE_FILE="/var/log/setup_done.marker"
if [ -f "$DONE_FILE" ]; then
    echo "Setup already completed. Exiting to avoid reboot loop."
    exit 0
fi

# 2. Standard openSUSE commandsÂ 
sudo zypper refresh
sudo zypper install -y curl jq

# 3. Add NVIDIA Repository
sudo zypper ar https://developer.download.nvidia.com/compute/cuda/repos/sles15/x86_64/cuda-sles15.repo
sudo zypper --gpg-auto-import-keys refresh

# 4. Install Drivers
sudo zypper install -y --auto-agree-with-licenses nvidia-open-driver-G06-signed-cuda-kmp-default
sudo zypper install -y --auto-agree-with-licenses nvidia-compute-utils-G06

# 5. Environment Setup
echo 'export KUBECONFIG=/etc/rancher/rke2/rke2.yaml' | sudo tee -a /etc/profile.d/rke2.sh
echo 'export PATH=$PATH:/var/lib/rancher/rke2/bin:/usr/local/nvidia/toolkit' | sudo tee -a /etc/profile.d/rke2.sh

# 6. CREATE THE MARKER FILE before rebooting
sudo touch "$DONE_FILE"
sync

# 7. Final Reboot (will only happen once now)
#sudo reboot
